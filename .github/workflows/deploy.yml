name: ğŸš€ Deploy Telegram MTProto to EC2

on:
  push:
    branches: [ main, production ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  APP_DIR: /home/ubuntu/telegram-mtproto

jobs:
  validate:
    name: ğŸ§ª Validate Environment
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ” Validate Required Secrets
      run: |
        echo "ğŸ” Validating deployment secrets..."
        [ -z "${{ secrets.TELEGRAM_API_ID }}" ] && echo "âŒ TELEGRAM_API_ID missing" && exit 1
        [ -z "${{ secrets.TELEGRAM_API_HASH }}" ] && echo "âŒ TELEGRAM_API_HASH missing" && exit 1
        [ -z "${{ secrets.DATABASE_URL }}" ] && echo "âŒ DATABASE_URL missing" && exit 1
        [ -z "${{ secrets.S3_BUCKET_NAME }}" ] && echo "âŒ S3_BUCKET_NAME missing" && exit 1
        [ -z "${{ secrets.EC2_HOST }}" ] && echo "âŒ EC2_HOST missing" && exit 1
        [ -z "${{ secrets.EC2_PRIVATE_KEY }}" ] && echo "âŒ EC2_PRIVATE_KEY missing" && exit 1
        echo "âœ… All required secrets validated"

  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup SSH Connection
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
        echo "âœ… SSH connection configured"
    
    - name: ğŸš€ Execute Deployment on EC2
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
          set -e
          
          echo "ğŸ¯ Starting deployment to ${{ env.APP_DIR }}"
          echo "ğŸ“… Deployment time: $(date)"
          echo "ğŸ”§ Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          
          # Create application directory
          mkdir -p ${{ env.APP_DIR }}
          cd ${{ env.APP_DIR }}
          
          # Backup existing deployment
          if [ -d ".git" ] && [ -f "docker-compose.yml" ]; then
            echo "ğŸ’¾ Creating backup of current deployment..."
            BACKUP_DIR="../telegram-mtproto-backup-$(date +%Y%m%d-%H%M%S)"
            cp -r . "$BACKUP_DIR"
            echo "âœ… Backup created: $BACKUP_DIR"
          fi
          
          # Stop existing containers gracefully
          echo "ğŸ›‘ Stopping existing containers..."
          if [ -f "docker-compose.yml" ]; then
            docker-compose down --timeout 30 --remove-orphans || true
          fi
          
          # Clone or update repository
          if [ -d ".git" ]; then
            echo "ğŸ“¥ Updating existing repository..."
            git fetch origin
            git reset --hard origin/${{ github.ref_name }}
            git clean -fd
            echo "âœ… Repository updated to latest commit"
          else
            echo "ğŸ“¥ Cloning repository for first deployment..."
            git clone https://github.com/${{ github.repository }}.git .
            git checkout ${{ github.ref_name }}
            echo "âœ… Repository cloned successfully"
          fi
          
          # Create production environment file
          echo "ğŸ“ Creating production environment configuration..."
          cat > .env << 'ENVEOF'
        # Telegram MTProto Configuration
        TELEGRAM_API_ID=${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH=${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_PHONE=${{ secrets.TELEGRAM_PHONE }}
        
        # Database Configuration
        DATABASE_URL=${{ secrets.DATABASE_URL }}
        
        # AWS Configuration
        AWS_DEFAULT_REGION=${{ secrets.AWS_DEFAULT_REGION }}
        S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
        
        # Lambda Function Names
        VIDEO_PROCESSOR_FUNCTION_NAME=${{ secrets.VIDEO_PROCESSOR_FUNCTION_NAME }}
        RESPONSE_HANDLER_FUNCTION_NAME=${{ secrets.RESPONSE_HANDLER_FUNCTION_NAME }}
        
        # Optional: Bot Token for Notifications
        TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
        
        # Application Configuration
        ENVIRONMENT=production
        LOG_LEVEL=INFO
        
        # Deployment Metadata
        GITHUB_SHA=${{ github.sha }}
        GITHUB_REF=${{ github.ref_name }}
        DEPLOYED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        DEPLOYED_BY=github-actions
        ENVEOF
          
          echo "âœ… Environment configuration created"
          
          # Clean up old Docker resources
          echo "ğŸ§¹ Cleaning up old Docker resources..."
          docker system prune -f --volumes || true
          docker image prune -a -f || true
          
          # Build new Docker image
          echo "ğŸ—ï¸ Building new Docker image..."
          docker-compose build --no-cache --parallel
          
          # Start new containers
          echo "ğŸš€ Starting new application containers..."
          docker-compose up -d
          
          # Wait for application startup
          echo "â³ Waiting for application to initialize..."
          sleep 45
          
          # Comprehensive health check
          echo "ğŸ¥ Performing application health checks..."
          HEALTH_ATTEMPTS=0
          MAX_HEALTH_ATTEMPTS=12
          HEALTH_SUCCESS=false
          
          while [ $HEALTH_ATTEMPTS -lt $MAX_HEALTH_ATTEMPTS ] && [ "$HEALTH_SUCCESS" = false ]; do
            HEALTH_ATTEMPTS=$((HEALTH_ATTEMPTS + 1))
            
            if curl -f -s --max-time 10 http://localhost:8000/health > /dev/null 2>&1; then
              echo "âœ… Health check passed on attempt $HEALTH_ATTEMPTS"
              HEALTH_SUCCESS=true
            else
              echo "â³ Health check attempt $HEALTH_ATTEMPTS/$MAX_HEALTH_ATTEMPTS failed, retrying in 10s..."
              sleep 10
            fi
          done
          
          if [ "$HEALTH_SUCCESS" = false ]; then
            echo "âŒ Health checks failed after $MAX_HEALTH_ATTEMPTS attempts"
            echo "ğŸ“Š Container status:"
            docker-compose ps
            echo "ğŸ“‹ Recent container logs:"
            docker-compose logs --tail=100 telegram-mtproto
            exit 1
          fi
          
          # Final deployment verification
          echo "ğŸ“Š Final deployment verification:"
          echo "ğŸ³ Container Status:"
          docker-compose ps
          
          echo "ğŸ“‹ Application Logs (Last 20 lines):"
          docker-compose logs --tail=20 telegram-mtproto
          
          echo "ğŸ”— Application Endpoints:"
          echo "   Main: http://localhost:8000"
          echo "   Health: http://localhost:8000/health"
          
          # Cleanup old backups (keep only 3 most recent)
          echo "ğŸ§¹ Cleaning up old deployment backups..."
          ls -dt ../telegram-mtproto-backup-* 2>/dev/null | tail -n +4 | xargs -r rm -rf
          
          echo ""
          echo "ğŸ‰ DEPLOYMENT COMPLETED SUCCESSFULLY! ğŸ‰"
          echo "ğŸ“… Completed at: $(date)"
          echo "ğŸš€ Application is now running in production"
          echo ""
        ENDSSH
    
    - name: ğŸ§¹ Cleanup SSH Keys
      if: always()
      run: |
        rm -f ~/.ssh/id_rsa
        echo "âœ… SSH cleanup completed"
    
    - name: ğŸ“Š Generate Deployment Summary
      run: |
        echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Environment** | Production |" >> $GITHUB_STEP_SUMMARY
        echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **EC2 Host** | \`${{ secrets.EC2_HOST }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Deployed At** | $(date -u) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— Application URLs" >> $GITHUB_STEP_SUMMARY
        echo "- **Main Application:** http://${{ secrets.EC2_HOST }}:8000" >> $GITHUB_STEP_SUMMARY
        echo "- **Health Check:** http://${{ secrets.EC2_HOST }}:8000/health" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY

  notify:
    name: ğŸ“¢ Post-Deployment Notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
    - name: ğŸ“¢ Notify Deployment Status
      run: |
        if [ "${{ needs.deploy.result }}" = "success" ]; then
          echo "âœ… Deployment notification: SUCCESS"
        else
          echo "âŒ Deployment notification: FAILED"
        fi
